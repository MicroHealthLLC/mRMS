<script type="text/javascript" src="https://js.live.net/v7.2/OneDrive.js"></script>

<div data-toggle="modal" class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div data-toggle="modal" class="modal-dialog" role="document">
    <div data-toggle="modal" class="modal-content">
      <div data-toggle="modal" class="modal-header">
        <h4 class="modal-title" id="myModalLabel">Upload Files</h4>
      </div>
      <div id="files" class="files col-xs-12" ></div>
      <div id="errors" style="color: red;" class="files col-xs-12" ></div>
      <%= form_for(@report, url: upload_document_channel_report_path(@channel, @report), method: :post, html: { class: 'form-horizontal' , method: :post,  :multipart => true, :id => "fileupload" }) do |f| %>
        <div data-toggle="modal" class="modal-body">
          <fieldset>
            <div class="form-group">
              <%= f.label t('document'), class: 'col-md-3 control-label text-align-left' %>
              <div class="col-md-9">
                <div class="upload-btn-wrapper">
                  <button class="btn btn-secondary">Upload a file</button>
                  <input id="fileupload" type="file" class="input-file" name="report[document]" />
                </div>
              </div>
              <div class="col-md-12 py-3 text-align-center">
                OR
              </div>
              <%= f.label t('one_drive'), class: 'col-md-3 control-label text-align-left' %>
              <div class="col-md-9">
                <div class="upload-btn-wrapper">
                  <button class="btn btn-info" id="OpenOneDrive">Open from OneDrive</button>
                </div>
              </div>
              <div class="col-md-12 py-3 text-align-center">
                OR
              </div>
              <div class="col-md-12">
                <label class="pt-3 pr-3" style="float: left">URL  </label>
                <%= text_field_tag :url, '', class: 'col-md-9 form-control' , style: 'width: 80%' %>
                <%= f.submit :save, class: 'btn btn-primary', style: 'float: right' %>
              </div>
              <style>
                .upload-btn-wrapper {
                  position: relative;
                  overflow: hidden;
                  display: inline-block;
                }
                .upload-btn-wrapper input[type=file] {
                  font-size: 100px;
                  position: absolute;
                  left: 0;
                  top: 0;
                  opacity: 0;
                }
              </style>
            </div>
          </fieldset>
        </div>
        <div data-toggle="modal" class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
      </div>
    <% end %>
  </div>
</div>

<script id="template-upload" type="text/x-tmpl">
  <div class="upload">
  {%=o.name%}
  <div class="progress"> <div class="progress-bar progress-bar-success"></div>  </div>
  </div>
</script>

<script>
    // ajout de la classe JS Ã  HTML
  $(document).ready(function(){
    $(function () {
      'use strict';
      url: '<%= upload_document_channel_report_path(@channel, @report) %>';
      $('#fileupload').fileupload({
        dataType: 'script',
        add: function(e, data){
          var uploadErrors = [];

          if(data.originalFiles[0]['size'].length && data.originalFiles[0]['size'] > <%= Setting['spreadsheet_limit'].to_i.megabytes %>) {
            uploadErrors.push('Filesize is too big');
          }
          if(uploadErrors.length > 0) {
            alert(uploadErrors.join("\n"));
          } else {
            data.context = $(tmpl('template-upload', data.files[0]));
            $('#files').append(data.context);
            data.submit()
          }
        },
        done: function (e, data) {
          data.context.hide();
        },
        fail: function (e, data) {
          $.each(data.messages, function (index, error) {
            $('<p style="color: red;">Upload file error: ' + error + '<i class="elusive-remove" style="padding-left:10px;"/></p>')
            .appendTo('#files');
          });
        },
        progress: function (e, data) {
          if( data.context) {
            var progress = parseInt(data.loaded / data.total * 100, 10);
            data.context.find('.progress-bar').css(
              'width',
              progress + '%'
            );
          }
        }
      }).prop('disabled', !$.support.fileInput)
        .parent().addClass($.support.fileInput ? undefined : 'disabled');
    });
  })

  document.getElementById("OpenOneDrive").addEventListener("click", function (e) {
    e.preventDefault();
    launchOneDrivePicker().then(function (result) {
      if (result) {
        const file = result.value
        var params = { report: { document: file } }
        console.log(params)
        $.ajax({
          type: "POST",
          url: '<%= upload_document_channel_report_path(@channel, @report) %>',
          data: params,
          success: function (result) {
            Swal.fire(
              'Successfully Added!',
              'Your file has been uploaded.',
              'success'
            )
          },
          error: function (){
            Swal.fire(
              'Something went wrong!',
              'Contact to Service Team!',
              'error'
            )
          }
        });
      }
    }).catch(function (reason) {
      console.log(reason);
    });
  });

  var oneDriveApplicationId = "<%= Setting['AZURE_KEY']%>";
  var baseUrl = "<%= Setting['CALLBACK_URL'] %>";
  function launchOneDrivePicker() {
    return new Promise(function (resolve, reject) {
      var odOptions = {
        clientId: oneDriveApplicationId,
        action: "download",
        multiSelect: false,
        openInNewWindow: true,
        advanced: {
          filter: "folder,.csv,.xls,.xlsx",
          redirectUri: baseUrl + "/welcome/onedriveredirect"
        },
        success: function (files) { resolve(files); },
        cancel: function () { resolve(null); },
        error: function (e) { reject(e); }
      };
      OneDrive.open(odOptions);
    });
  };
</script>
